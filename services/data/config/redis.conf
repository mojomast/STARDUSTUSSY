# HarmonyFlow SyncBridge - Redis Configuration
# Phase 1: Foundation (Week 1)

# =============================================================================
# GENERAL SETTINGS
# =============================================================================

# Network
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 300
tcp-keepalive 300

# Security
protected-mode yes
requirepass ${REDIS_PASSWORD:-changeme_in_production}

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Memory limit (adjust based on available RAM)
maxmemory 512mb
maxmemory-policy allkeys-lru

# =============================================================================
# PERSISTENCE CONFIGURATION
# =============================================================================

# RDB Snapshots (point-in-time backups)
save 900 1      # Save after 900 seconds if at least 1 key changed
save 300 10     # Save after 300 seconds if at least 10 keys changed  
save 60 10000   # Save after 60 seconds if at least 10000 keys changed

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# AOF (Append Only File) for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec  # Good balance of performance and durability
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# =============================================================================
# SESSION STORAGE CONFIGURATION
# =============================================================================

# Database selection for different data types
databases 16

# Database usage:
# 0 - Sessions (default)
# 1 - User metadata cache
# 2 - Rate limiting counters
# 3 - Feature flags
# 4 - Temporary data
# 5-15 - Reserved for future use

# =============================================================================
# TTL POLICIES
# =============================================================================

# Default TTL for sessions: 7 days (604800 seconds)
# Applied programmatically in application code
# Key structure: session:{user_id}:{session_token}

# Lazy expiration settings
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# =============================================================================
# CONNECTION POOLING
# =============================================================================

# Maximum connected clients
maxclients 10000

# Client output buffer limits (prevent slow clients from consuming memory)
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================================================
# LOGGING
# =============================================================================

loglevel notice
logfile ""

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Disable THP (Transparent Huge Pages)
# Set in host: echo never > /sys/kernel/mm/transparent_hugepage/enabled

# I/O threads (Redis 6.0+)
# io-threads 4
# io-threads-do-reads yes

# =============================================================================
# REPLICATION (for production cluster)
# =============================================================================

# replicaof <masterip> <masterport>
# masterauth <master-password>
# replica-serve-stale-data yes
# replica-read-only yes

# =============================================================================
# KEY STRUCTURE DOCUMENTATION
# =============================================================================

# SESSION KEYS:
#   Format: session:{user_id}:{session_token_hash}
#   TTL: 604800 (7 days)
#   Value: JSON with session data
#
# USER CACHE:
#   Format: user:{user_id}:profile
#   TTL: 3600 (1 hour)
#   Value: JSON user profile
#
# RATE LIMITING:
#   Format: ratelimit:{resource}:{user_id}
#   TTL: 60 (1 minute) or 3600 (1 hour)
#   Value: Integer counter
#
# FEATURE FLAGS:
#   Format: feature:{flag_name}
#   TTL: None (persistent)
#   Value: Boolean or percentage
