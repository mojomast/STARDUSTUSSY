# NGINX Ingress Controller Configuration
# Primary entry point for external traffic

---
# NGINX Ingress Controller HelmRelease
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
spec:
  interval: 5m
  chart:
    spec:
      chart: ingress-nginx
      version: "4.8.0"
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx
        namespace: flux-system
  values:
    controller:
      replicaCount: 2
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 512Mi
      
      # Enable metrics
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          namespace: monitoring
      
      # Enable opentracing for Linkerd
      opentracing:
        enabled: true
      
      # Pod Disruption Budget
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
      
      # Affinity
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - ingress-nginx
                topologyKey: kubernetes.io/hostname
      
      # Configuration
      config:
        use-proxy-protocol: "false"
        use-forwarded-headers: "true"
        compute-full-forwarded-for: "true"
        proxy-body-size: "50m"
        proxy-read-timeout: "60"
        proxy-send-timeout: "60"
        ssl-redirect: "true"
        hsts: "true"
        hsts-max-age: "31536000"
        hsts-include-subdomains: "true"
        
      # Service configuration
      service:
        type: LoadBalancer
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
          service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-west-2:ACCOUNT_ID:certificate/CERTIFICATE_ID"
          service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "https"
      
      # Enable admission webhooks
      admissionWebhooks:
        enabled: true
        certManager:
          enabled: true
          issuerRef:
            name: harmonyflow-internal-ca
            kind: ClusterIssuer
      
      # Enable topology aware routing
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx

    # Default backend
    defaultBackend:
      enabled: true
      replicaCount: 1
      resources:
        requests:
          cpu: 10m
          memory: 20Mi

---
# Namespace for Ingress Controller
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/component: ingress-controller

---
# Main Application Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: harmonyflow-app
  namespace: harmonyflow
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"
    # Enable CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://harmonyflow.io, https://*.harmonyflow.io"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, PUT, POST, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "10"
    nginx.ingress.kubernetes.io/limit-connections: "5"
spec:
  tls:
    - hosts:
        - api.harmonyflow.io
        - app.harmonyflow.io
      secretName: harmonyflow-app-tls
  rules:
    - host: api.harmonyflow.io
      http:
        paths:
          - path: /session
            pathType: Prefix
            backend:
              service:
                name: session-state-service
                port:
                  number: 80
          - path: /content
            pathType: Prefix
            backend:
              service:
                name: content-delivery-service
                port:
                  number: 80
          - path: /collaboration
            pathType: Prefix
            backend:
              service:
                name: collaboration-service
                port:
                  number: 80
          - path: /personalization
            pathType: Prefix
            backend:
              service:
                name: personalization-service
                port:
                  number: 80

---
# WebSocket Ingress for Session State Service
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: harmonyflow-websocket
  namespace: harmonyflow
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/proxy-set-headers: "upgrade, connection"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
spec:
  tls:
    - hosts:
        - ws.harmonyflow.io
      secretName: harmonyflow-ws-tls
  rules:
    - host: ws.harmonyflow.io
      http:
        paths:
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: session-state-service
                port:
                  number: 8080

---
# Monitoring Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: monitoring-ingress
  namespace: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required - Monitoring"
spec:
  tls:
    - hosts:
        - grafana.harmonyflow.io
        - prometheus.harmonyflow.io
        - alertmanager.harmonyflow.io
      secretName: monitoring-tls
  rules:
    - host: grafana.harmonyflow.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus-grafana
                port:
                  number: 80
    - host: prometheus.harmonyflow.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus-kube-prometheus-prometheus
                port:
                  number: 9090
    - host: alertmanager.harmonyflow.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: alertmanager-operated
                port:
                  number: 9093

---
# RabbitMQ Management Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rabbitmq-ingress
  namespace: rabbitmq
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: rabbitmq-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required - RabbitMQ"
spec:
  tls:
    - hosts:
        - rabbitmq.harmonyflow.io
      secretName: rabbitmq-tls
  rules:
    - host: rabbitmq.harmonyflow.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: rabbitmq-management
                port:
                  number: 15672

---
# Secret for monitoring basic auth
apiVersion: v1
kind: Secret
metadata:
  name: monitoring-basic-auth
  namespace: monitoring
type: Opaque
data:
  auth: "YWRtaW46JGFwcjEkSDY1dnFkNDAkWXM4N2NkZWxmLi44b3luaC5oMDM1bXouCg=="  # admin:CHANGE_ME

---
# Secret for RabbitMQ basic auth
apiVersion: v1
kind: Secret
metadata:
  name: rabbitmq-basic-auth
  namespace: rabbitmq
type: Opaque
data:
  auth: "YWRtaW46JGFwcjEkSDY1dnFkNDAkWXM4N2NkZWxmLi44b3luaC5oMDM1bXouCg=="  # admin:CHANGE_ME

---
# ServiceMonitor for NGINX metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nginx-ingress-metrics
  namespace: ingress-nginx
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/component: controller
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
