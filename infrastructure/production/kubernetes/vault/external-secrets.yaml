# External Secrets Operator for Production
# Syncs secrets from Vault to Kubernetes

---
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets
  labels:
    name: external-secrets
    environment: production

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-secrets
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: controller
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: external-secrets
  template:
    metadata:
      labels:
        app.kubernetes.io/name: external-secrets
    spec:
      serviceAccountName: external-secrets
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
      - name: external-secrets
        image: ghcr.io/external-secrets/external-secrets:v0.9.13
        imagePullPolicy: IfNotPresent
        args:
        - --watch-timeout=1m
        - --concurrency=10
        env:
        - name: LOGGER_JSON
          value: "true"
        - name: METRICS_PORT
          value: "8080"
        ports:
        - containerPort: 8080
          name: metrics
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 20
          timeoutSeconds: 5
          failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
apiVersion: v1
kind: Service
metadata:
  name: external-secrets
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    name: metrics
  selector:
    app.kubernetes.io/name: external-secrets

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-secrets
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["secrets/status"]
  verbs: ["get", "update", "patch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets/status"]
  verbs: ["get", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["secretstores"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["external-secrets.io"]
  resources: ["secretstores/status"]
  verbs: ["get", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["clustersecretstores"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["external-secrets.io"]
  resources: ["clustersecretstores/status"]
  verbs: ["get", "update", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-secrets
subjects:
- kind: ServiceAccount
  name: external-secrets
  namespace: external-secrets

---
# ClusterSecretStore for Vault (Production)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend-production
spec:
  provider:
    vault:
      server: "https://vault.harmonyflow.io"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
  condition:
    type: All
    namespaces:
    - harmonyflow-production
    - postgresql
    - redis-production
    - rabbitmq-production

---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend-staging
spec:
  provider:
    vault:
      server: "https://vault-staging.harmonyflow.io"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
  condition:
    type: All
    namespaces:
    - harmonyflow-staging
    - postgresql-staging
    - redis-staging
    - rabbitmq-staging

---
# Session State Service Secrets (Production)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: session-state-service-secrets
  namespace: harmonyflow-production
spec:
  refreshInterval: "1h"
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend-production
  target:
    name: session-state-service-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        JWT_SECRET: "{{ .JWT_SECRET }}"
        JWT_REFRESH_SECRET: "{{ .JWT_REFRESH_SECRET }}"
        JWT_SECRET_PREVIOUS: "{{ .JWT_SECRET_PREVIOUS }}"
        JWT_SECRET_NEXT: "{{ .JWT_SECRET_NEXT }}"
        API_KEY: "{{ .API_KEY }}"
        ENCRYPTION_KEY: "{{ .ENCRYPTION_KEY }}"
        REDIS_PASSWORD: "{{ .REDIS_PASSWORD }}"
  data:
  - secretKey: JWT_SECRET
    remoteRef:
      key: secret/data/harmonyflow/session-state-service
      property: jwt-secret
  - secretKey: JWT_REFRESH_SECRET
    remoteRef:
      key: secret/data/harmonyflow/session-state-service
      property: jwt-refresh-secret
  - secretKey: JWT_SECRET_PREVIOUS
    remoteRef:
      key: secret/data/harmonyflow/session-state-service
      property: jwt-secret-previous
    optional: true
  - secretKey: JWT_SECRET_NEXT
    remoteRef:
      key: secret/data/harmonyflow/session-state-service
      property: jwt-secret-next
    optional: true
  - secretKey: API_KEY
    remoteRef:
      key: secret/data/harmonyflow/session-state-service
      property: api-key
  - secretKey: ENCRYPTION_KEY
    remoteRef:
      key: secret/data/harmonyflow/session-state-service
      property: encryption-key
  - secretKey: REDIS_PASSWORD
    remoteRef:
      key: secret/data/harmonyflow/redis
      property: password

---
# PostgreSQL Credentials (Production)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgresql-credentials
  namespace: postgresql
spec:
  refreshInterval: "1h"
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend-production
  target:
    name: postgresql-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        password: "{{ .password }}"
        replication-password: "{{ .replication-password }}"
        admin-password: "{{ .admin-password }}"
  data:
  - secretKey: password
    remoteRef:
      key: secret/data/harmonyflow/postgresql
      property: password
  - secretKey: replication-password
    remoteRef:
      key: secret/data/harmonyflow/postgresql
      property: replication-password
  - secretKey: admin-password
    remoteRef:
      key: secret/data/harmonyflow/postgresql
      property: admin-password

---
# Redis Credentials (Production)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: redis-production
spec:
  refreshInterval: "1h"
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend-production
  target:
    name: redis-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        password: "{{ .password }}"
        standby-password: "{{ .standby-password }}"
  data:
  - secretKey: password
    remoteRef:
      key: secret/data/harmonyflow/redis
      property: password
  - secretKey: standby-password
    remoteRef:
      key: secret/data/harmonyflow/redis
      property: standby-password

---
# RabbitMQ Credentials (Production)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: rabbitmq-credentials
  namespace: rabbitmq-production
spec:
  refreshInterval: "1h"
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend-production
  target:
    name: rabbitmq-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        username: "{{ .username }}"
        password: "{{ .password }}"
        cookie: "{{ .cookie }}"
        erlang-cookie: "{{ .erlang-cookie }}"
  data:
  - secretKey: username
    remoteRef:
      key: secret/data/harmonyflow/rabbitmq
      property: username
  - secretKey: password
    remoteRef:
      key: secret/data/harmonyflow/rabbitmq
      property: password
  - secretKey: cookie
    remoteRef:
      key: secret/data/harmonyflow/rabbitmq
      property: cookie
  - secretKey: erlang-cookie
    remoteRef:
      key: secret/data/harmonyflow/rabbitmq
      property: erlang-cookie

---
# Admin API Token (Production)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: admin-api-token
  namespace: harmonyflow-production
spec:
  refreshInterval: "1h"
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend-production
  target:
    name: admin-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        ADMIN_API_TOKEN: "{{ .admin_api_token }}"
  data:
  - secretKey: admin_api_token
    remoteRef:
      key: secret/data/harmonyflow/admin
      property: api-token
